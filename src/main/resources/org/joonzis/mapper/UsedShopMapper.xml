<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.joonzis.mapper.UsedShopMapper">
	
	<!-- 전체 책 리스트 조회 -->
<select id="getuBookList" parameterType="org.joonzis.domain.Criteria" resultType="org.joonzis.domain.UsedBookVO">
	<![CDATA[
		SELECT ubno, mno, gno, ubookPrice, title, content, ubookImage, status, ubookDate
		FROM (
			SELECT ROWNUM rn, ubno, mno, gno, ubookPrice, title, content, ubookImage, status, ubookDate 
			FROM (
				SELECT * FROM tbl_ubook 
				ORDER BY ubno DESC
			)
			WHERE ROWNUM <= #{pageNum} * #{amount}
		)
		WHERE rn > (#{pageNum} - 1) * #{amount}
	]]>
</select>

	
	<!-- 카테고리 별 책 리스트 조회 -->
	<!-- <select id="getuBookListGe" parameterType="org.joonzis.domain.Criteria" resultType="org.joonzis.domain.UsedBookVO">
		<![CDATA[
		select ubno, mno, gno, ubookPrice, title, content, ubookImage, status, ubookDate from
		(select rownum rn, ubno, mno, gno, ubookPrice, title, content, ubookImage, status, ubookDate from
		(select * from tbl_ubook where gno = #{gener} ORDER BY status DESC)
		where rownum <= #{pageNum} * #{amount})
		where rn > (#{pageNum} - 1) * #{amount}
		]]>
	</select> -->
	
	<!-- 전체 책 개수 조회 -->
	<select id="getTotal" resultType="int">
		 select count(*) from tbl_ubook
	</select>
	
	<!-- 카테고리 별 책 개수 조회 -->
	<select id="getTotalByGno" parameterType="int" resultType="int">
		 select count(*) from tbl_ubook where gno = #{gno}
	</select>
	
	<!-- 중고상품 등록 -->
	<insert id="usedShopInsert" parameterType="org.joonzis.domain.UsedBookVO">
		insert into tbl_ubook values ( seq_ubno.nextval , #{mno}, #{gno}, #{title}, #{content}, #{ubookPrice}, #{ubookImage}, #{status}, sysdate)
	</insert>
	
	<!-- ubno 조회 -->
	<select id="selectUbno" resultType="int">
		select max(ubno) from tbl_ubook
	</select>
	
	<!-- 중고상품 이미지 등록 -->
	<insert id="usedShopImgInsert" parameterType="org.joonzis.domain.usedBookImgVO">
		insert into tbl_ubook_image values ( #{ubno}, #{ubookimage} )
	</insert>
	
	<!-- 중고 상품 보기 by.ubno -->
	<select id="getuBookOne" parameterType="int" resultType="org.joonzis.domain.UsedBookVO">
		select * from tbl_ubook where ubno = #{ubno}
	</select>
	
	<!-- 중고 상품 이미지 보기 -->
	<select id="getuBookImgByUbno" parameterType="int" resultType="org.joonzis.domain.usedBookImgVO">
		select * from tbl_ubook_image where ubno = #{ubno}
	</select>
	
	<!-- 실시간 채팅 방 유무 check -->
	<select id="chatingRoomCheck" parameterType="org.joonzis.domain.ChatRoomDTO" resultType="int">
		select count(*) from tbl_chat_room where ubno = #{ubno} AND sellmno = #{sellmno} AND buymno = #{buymno}
	</select>
	
	<!-- 실시간 채팅 방 insert -->
	<insert id="chatingRoomInsert" parameterType="org.joonzis.domain.ChatRoomDTO">
		insert into tbl_chat_room values ( SEQ_CHATNO.nextval, #{ubno}, #{sellmno}, #{buymno}, sysdate )
	</insert>
	
	<!-- 채팅 방 접근을 위한 번호 조회 -->
	<select id="getChattingNumber" parameterType="org.joonzis.domain.ChatRoomDTO" resultType="int">
		select chatno from tbl_chat_room where ubno = #{ubno} AND sellmno = #{sellmno} AND buymno = #{buymno}
	</select>
	
	<!-- 채팅 방 메시지 insert -->
	<insert id="insertChattingContent" parameterType="org.joonzis.domain.ChattingDTO">
		insert into tbl_chat_content values (#{chatno}, #{mno}, #{content}, sysdate)
	</insert>
	<!-- 채팅 방 메시지 조회 -->
	<select id="getChattingContent" parameterType="int" resultType="org.joonzis.domain.ChattingDTO">
		select * from tbl_chat_content where chatno = #{chatno} order by chatdate
	</select>
	
	<!-- 판매자용 채팅 방 리스트 -->
	<select id="selectSellChatRoomList" parameterType="org.joonzis.domain.ChatRoomDTO" resultType="org.joonzis.domain.ChatRoomDTO">
		select * from tbl_chat_room where ubno = #{ubno} and sellmno = #{sellmno}
	</select>
</mapper>
